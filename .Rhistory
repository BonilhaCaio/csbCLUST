tabPanel(
value = "markers_tab",
title = tagList(icon("sliders"), "Markers"),
br(),
fluidRow(
## ---- LEFT COLUMN ----
column(
width = 3,
div(
style = "border:1px solid #000; padding:10px;",
selectInput(
"marker_image",
tagList(icon("image"), "Select sample"),
choices = NULL
),
selectInput(
"marker_channel",
tagList(icon("layer-group"), "Select channel"),
choices = NULL
),
textInput(
"marker_name",
label = tagList(icon("tag"), "Marker name"),
placeholder = "e.g. CD3, MHC-II"
),
verbatimTextOutput("current_marker_names"),
actionButton(
"marker_confirm",
label = tagList(icon("check"), "Ok"),
style = "background-color:white; color:black; border:1px solid black;"
),
hr(),
actionButton(
"markers_proceed",
"Proceed",
class = "btn-primary",
disabled = TRUE
)
)
),
## ---- RIGHT COLUMN ----
column(
width = 6,
div(
style = "
width:100%;
height:100vh;
overflow:hidden;
",
imageOutput(
"marker_plot",
width = "100%",
height = "auto"
)
)
),
column(3)
)
),
## TAB 3 — SYNAPSE
tabPanel(
value = "synapse_tab",
title = tagList(icon("share-nodes"), "Synapse"),
br(),
fluidRow(
## ---- LEFT COLUMN ----
column(
width = 3,
div(
style = "border:1px solid #000; padding:10px;",
selectInput(
"synapse_image",
tagList(icon("image"), "Select sample"),
choices = NULL
),
br(),
checkboxInput(
"synapse_overlay",
tagList(icon("layer-group"), "Overlay original image"),
TRUE
),
br(),
radioButtons(
"selected_cell",
label = tagList("Cell to analyse"),
choices = c(
"Cell 1 (white)" = 1,
"Cell 2 (yellow)" = 2
),
selected = 2
),
hr(),
actionButton(
"synapse_proceed",
"Proceed",
class = "btn-primary"
)
)
),
## ---- RIGHT COLUMN ----
column(
width = 6,
div(
style = "
width:100%;
height:100vh;
overflow:hidden;
",
imageOutput(
"synapse_plot",
width = "100%",
height = "auto"
)
)
),
column(3)
)
),
## TAB 4 — TABLE
tabPanel(
value = "table_tab",
title = tagList(icon("table"), "Table"),
br(),
fluidRow(
column(
9,
checkboxGroupInput(
"channels_to_show",
label = tagList("Channels to include"),
choices = NULL,
inline = TRUE
)
),
column(
3,
align = "right",
actionButton(
"table_proceed",
"Proceed",
class = "btn-primary"
)
)
),
br(), br(),
fluidRow(
column(
12,
DTOutput("results_table")
)
)
),
## TAB 5 — EXPORTS
tabPanel(
value = "exports_tab",
title = tagList(icon("file-export"), "Exports"),
div(
style = "
height:70vh;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
",
shinyDirButton(
"export_dir",
"Select export folder",
"Select export folder"
),
br(),
actionButton(
"export_run",
tagList("Export images and stats"),
class = "btn-primary",
disabled = TRUE
)
)
)
)
)
## csbSYNAPSE — FULL SERVER
## Message 4 / 4
server <- function(input, output, session) {
## 0. ABOUT MODAL
observeEvent(input$about, {
showModal(
modalDialog(
title = "csbSYNAPSE",
"csbSYNAPSE quantifies membrane marker enrichment at the
immunological synapse by comparing synaptic and non-synaptic
membrane regions in confocal microscopy images.",
br(), br(),
strong("Project website:"),
"https://github.com/BonilhaCaio/csbSYNAPSE",
footer = NULL,
size = "m",
easyClose = TRUE
)
)
})
## 1. FILE SYSTEM (IDENTICAL TO csbCLUST)
volumes <- c(Home = normalizePath("~"), Root = "/")
shinyDirChoose(input, "input_dir", roots = volumes, session = session)
shinyDirChoose(input, "export_dir", roots = volumes, session = session)
## 2. GLOBAL STATE
rv <- reactiveValues(
input_dir  = NULL,
export_dir = NULL,
images     = NULL,
metadata   = NULL,
analysis   = NULL,
marker_names = list(),
selected_cell = 2
)
## 3. INPUT TAB
observeEvent(input$input_dir, {
path <- parseDirPath(volumes, input$input_dir)
if (length(path) == 0 || !dir.exists(path)) {
disable("input_proceed")
return()
}
rv$input_dir <- path
enable("input_proceed")
})
observeEvent(input$input_proceed, {
disable("input_dir")
disable("input_proceed")
tif_files <- list.files(
rv$input_dir,
pattern = "\\.tif(f)?$",
full.names = TRUE,
ignore.case = TRUE
)
if (length(tif_files) == 0) {
stop("No TIFF files found in input directory.")
}
images <- lapply(tif_files, function(f) {
img <- readImage(f)
if (length(dim(img)) != 3 || dim(img)[3] < 2) {
stop(paste("Image must have at least 2 channels:", basename(f)))
}
img
})
names(images) <- basename(tif_files)
rv$images   <- images
rv$metadata <- tibble(
file_name = basename(tif_files),
file_path = tif_files
)
updateTabsetPanel(session, "main_tabs", "markers_tab")
})
## 4. MARKERS TAB
output$current_marker_names <- renderText({
req(rv$images)
if (length(rv$marker_names) == 0) {
return("No marker names assigned yet.")
}
paste(
paste0(names(rv$marker_names), " → ", rv$marker_names),
collapse = "\n"
)
})
observe({
req(rv$images)
updateSelectInput(
session,
"marker_image",
choices = names(rv$images)
)
})
observeEvent(input$marker_image, {
req(rv$images)
img <- rv$images[[input$marker_image]]
updateSelectInput(
session,
"marker_channel",
choices = paste0("Ch", seq_len(dim(img)[3]))
)
})
output$marker_plot <- renderImage({
req(input$marker_image, input$marker_channel)
ch <- as.integer(gsub("Ch", "", input$marker_channel))
img <- rv$images[[input$marker_image]][,,ch]
tmp <- tempfile(fileext = ".png")
writeImage(normalize(img), tmp)
list(src = tmp, contentType = "image/png", deleteFile = TRUE)
}, deleteFile = TRUE)
observeEvent(input$marker_confirm, {
req(input$marker_channel, input$marker_name)
rv$marker_names[[input$marker_channel]] <- input$marker_name
updateTextInput(
session,
"marker_name",
value = ""
)
img <- rv$images[[input$marker_image]]
all_channels <- paste0("Ch", seq_len(dim(img)[3]))
if (all(all_channels %in% names(rv$marker_names))) {
enable("markers_proceed")
}
})
observeEvent(input$markers_proceed, {
shinyjs::disable(selector = "button")
withProgress(message = "Running csbSYNAPSE analysis", value = 0, {
rv$analysis <- csbSYNAPSE_sections2to5(rv$images)
})
shinyjs::enable(selector = "button")
updateTabsetPanel(session, "main_tabs", "synapse_tab")
})
## 5. SYNAPSE TAB
observe({
req(rv$analysis)
updateSelectInput(
session,
"synapse_image",
choices = names(rv$analysis$images)
)
})
observeEvent(input$selected_cell, {
rv$selected_cell <- as.integer(input$selected_cell)
})
output$synapse_plot <- renderImage({
req(input$synapse_image, rv$analysis)
img_name <- input$synapse_image
img <- rv$analysis$images[[img_name]]
mem1 <- rv$analysis$membranes[[img_name]]$cell1 > 0
mem2 <- rv$analysis$membranes[[img_name]]$cell2 > 0
syn  <- rv$analysis$synapse[[img_name]]$outline > 0
h <- dim(img)[1]
w <- dim(img)[2]
rgb <- array(0, dim = c(h, w, 3))
if (isTRUE(input$synapse_overlay)) {
base <- img[,,1]
base <- base - min(base)
if (max(base) > 0) base <- base / max(base)
rgb[,,1] <- base
rgb[,,2] <- base
rgb[,,3] <- base
}
rgb[,,1][mem1] <- 1
rgb[,,2][mem1] <- 1
rgb[,,3][mem1] <- 1
rgb[,,1][mem2] <- 1
rgb[,,2][mem2] <- 1
rgb[,,1][syn] <- 1
rgb[,,2][syn] <- 0
rgb[,,3][syn] <- 0
out <- Image(rgb, colormode = "Color")
tmp <- tempfile(fileext = ".png")
writeImage(out, tmp)
list(src = tmp, contentType = "image/png", deleteFile = TRUE)
}, deleteFile = TRUE)
observeEvent(input$synapse_proceed, {
updateTabsetPanel(session, "main_tabs", "table_tab")
})
## 6. TABLE TAB
observe({
req(rv$analysis, rv$marker_names)
updateCheckboxGroupInput(
session,
"channels_to_show",
choices  = setNames(names(rv$marker_names), rv$marker_names),
selected = names(rv$marker_names)
)
})
results_df <- reactive({
req(rv$analysis, input$channels_to_show)
rows <- list()
for (img_name in names(rv$analysis$images)) {
reg <- rv$analysis$cell_membrane_regions[[img_name]][[paste0("cell", rv$selected_cell)]]
if (is.null(reg)) next
for (ch_name in input$channels_to_show) {
ch_id <- as.integer(sub("^Ch", "", ch_name))
img   <- rv$analysis$images[[img_name]][,,ch_id]
IS_vals    <- img[reg$IS_membrane]
nonIS_vals <- img[reg$nonIS_membrane]
IS_mean    <- mean(IS_vals, na.rm = TRUE)
nonIS_mean <- mean(nonIS_vals, na.rm = TRUE)
rows[[length(rows) + 1]] <- data.frame(
sample = img_name,
channel = rv$marker_names[[ch_name]],
IS_intensity = IS_mean,
nonIS_intensity = nonIS_mean,
IS_nonIS_ratio = round(IS_mean / nonIS_mean, 2),
stringsAsFactors = FALSE
)
}
}
do.call(rbind, rows)
})
output$results_table <- renderDT({
datatable(
results_df(),
rownames = FALSE,
options = list(dom = "t", paging = FALSE)
) %>%
formatRound(
columns = c("IS_intensity", "nonIS_intensity"),
digits = 2
)
})
observeEvent(input$table_proceed, {
updateTabsetPanel(session, "main_tabs", "exports_tab")
})
## 7. EXPORT TAB
observeEvent(input$main_tabs, {
if (input$main_tabs == "exports_tab") {
disable("export_run")
}
})
build_synapse_image <- function(img_name, analysis, overlay = TRUE) {
img <- analysis$images[[img_name]]
mem1 <- analysis$membranes[[img_name]]$cell1 > 0
mem2 <- analysis$membranes[[img_name]]$cell2 > 0
syn  <- analysis$synapse[[img_name]]$outline > 0
h <- dim(img)[1]
w <- dim(img)[2]
rgb <- array(0, dim = c(h, w, 3))
if (isTRUE(overlay)) {
base <- img[,,1]
base <- base - min(base)
if (max(base) > 0) base <- base / max(base)
rgb[,,1] <- base
rgb[,,2] <- base
rgb[,,3] <- base
}
## Cell 1 = white
rgb[,,1][mem1] <- 1
rgb[,,2][mem1] <- 1
rgb[,,3][mem1] <- 1
## Cell 2 = yellow
rgb[,,1][mem2] <- 1
rgb[,,2][mem2] <- 1
## Synapse = red
rgb[,,1][syn] <- 1
rgb[,,2][syn] <- 0
rgb[,,3][syn] <- 0
Image(rgb, colormode = "Color")
}
observeEvent(input$export_dir, {
disable("export_run")
path <- parseDirPath(volumes, input$export_dir)
if (length(path) == 0) {
rv$export_dir <- NULL
return()
}
if (!dir.exists(path)) {
rv$export_dir <- NULL
return()
}
if (is.null(rv$input_dir) || identical(path, rv$input_dir)) {
rv$export_dir <- NULL
return()
}
rv$export_dir <- path
enable("export_run")
})
observeEvent(input$export_run, {
shinyjs::disable(selector = "button")
showModal(
modalDialog(
title = "Export in progress",
icon("hourglass-half"),
"Exporting images and statistics...",
footer = NULL,
easyClose = FALSE
)
)
tbl <- isolate(results_df())
write.csv(
tbl,
file.path(rv$export_dir, "csbSYNAPSE_results.csv"),
row.names = FALSE
)
## ---- EXPORT SYNAPSE IMAGES ----
for (img_name in names(rv$analysis$images)) {
if (is.null(rv$analysis$synapse[[img_name]])) next
out_img <- build_synapse_image(
img_name  = img_name,
analysis  = rv$analysis,
overlay   = input$synapse_overlay
)
suffix <- if (isTRUE(input$synapse_overlay)) {
"overlay"
} else {
"mask"
}
out_file <- file.path(
rv$export_dir,
paste0(tools::file_path_sans_ext(img_name),
"_synapse_",
suffix,
".png")
)
writeImage(out_img, out_file)
}
removeModal()
showModal(
modalDialog(
title = "Export completed",
icon("circle-check"),
"All files were successfully exported.",
footer = modalButton("OK"),
easyClose = TRUE
)
)
shinyjs::enable(selector = "button")
})
}
shinyApp(ui, server)
}setwd("/Users/caio/Documents")
setwd("/Users/caio/Documents")
usethis::create_package("csbSYNAPSE")
